(function(){
  // State
  let difficulty = 'two';
  let worksheets = [];
  let showAnswer = false;
  // Ranges
  const ranges = {
    one: { min:1, max:9 },
    two: { min:10, max:99 },
    three: { min:100, max:999 }
  };
  // Utilities
  function randomIn(range){
    return Math.floor(Math.random() * (range.max - range.min + 1)) + range.min;
  }
  // DOM
  const btnOne = document.getElementById('btn-one');
  const btnTwo = document.getElementById('btn-two');
  const btnThree = document.getElementById('btn-three');
  const genBtn = document.getElementById('genBtn');
  const resetBtn = document.getElementById('resetBtn');
  const answerBtn = document.getElementById('answerBtn');
  const printBtn = document.getElementById('printBtn');
  const numDaysInput = document.getElementById('numDays');
  const printArea = document.getElementById('printArea');
  const message = document.getElementById('message');
  // Set difficulty UI
  function setDifficulty(level, el){
    difficulty = level;
    [btnOne, btnTwo, btnThree].forEach(b => b.classList.remove('active'));
    if(el) el.classList.add('active');
  }
  btnOne.addEventListener('click', ()=> setDifficulty('one', btnOne));
  btnTwo.addEventListener('click', ()=> setDifficulty('two', btnTwo));
  btnThree.addEventListener('click', ()=> setDifficulty('three', btnThree));
  // Generate
  function generateProblems(){
    const range = ranges[difficulty];
    const days = Math.max(1, Math.min(30, parseInt(numDaysInput.value, 10) || 1));
    worksheets = [];
    for(let day=1; day<=days; day++){
      const add = [];
      const sub = [];
      while(add.length < 20){
        const a = randomIn(range);
        const b = randomIn(range);
        if(a % 10 === b % 10) continue; // avoid same unit digit
        add.push({a,b});
      }
      while(sub.length < 20){
        let a = randomIn(range);
        let b = randomIn(range);
        if(a % 10 === b % 10) continue;
        if(a < b) [a,b] = [b,a];
        sub.push({a,b});
      }
      worksheets.push({ day, add, sub });
    }
    showAnswer = false;
    render();
    answerBtn.disabled = false;
    printBtn.disabled = false;
  }
  function resetAll(){
    worksheets = [];
    showAnswer = false;
    printArea.innerHTML = '';
    message.style.display = 'block';
    answerBtn.disabled = true;
    printBtn.disabled = true;
  }
  function toggleAnswer(){
    showAnswer = !showAnswer;
    render();
  }
  // ìˆ˜ì •ëœ print ì´ë²¤íŠ¸: ê°•ì œ ë¦¬í”Œë¡œìš° + ì§€ì—° í˜¸ì¶œ
  printBtn.addEventListener('click', () => {
    // ê°•ì œ DOM ë¦¬í”Œë¡œìš°: ë ˆì´ì•„ì›ƒ ë©”íŠ¸ë¦­ìŠ¤ ì½ê¸° (Safariê°€ DOM ì¬ê³„ì‚°í•˜ê²Œ í•¨)
    void printArea.offsetHeight; // ë˜ëŠ” printArea.getBoundingClientRect();
    console.log('Reflow forced'); // ë””ë²„ê¹…ìš©, ë‚˜ì¤‘ì— ì œê±°

    // ì§€ì—°ìœ¼ë¡œ print í˜¸ì¶œ: iOSì—ì„œ ë Œë”ë§ ê¸°ë‹¤ë¦¼ (0msë„ íš¨ê³¼ ìˆì§€ë§Œ, 100msë¡œ ì•ˆì „í•˜ê²Œ)
    setTimeout(() => {
      window.print();
    }, 100); // 0~500ms ì‚¬ì´ í…ŒìŠ¤íŠ¸ í•´ë³´ì„¸ìš”. ë„ˆë¬´ ê¸¸ë©´ UX ë‚˜ë¹ ì§.
  });
  // Render helpers
  function createWorksheetHTML(day, problems, op, title){
    const left = problems.slice(0,10);
    const right = problems.slice(10,20);
    let html = '';
    html += `<div class="worksheet">`;
    html += `<div class="ws-header"><div class="ws-title"><span class="day-num">${day}</span>ì¼ì°¨ - ${title}</div></div>`;
    html += `<div class="ws-info"><div class="info-group">ğŸ“…<input class="info-field" placeholder="ì›”"><input class="info-field" placeholder="ì¼"></div><div class="info-group">ğŸ•<input class="info-field" placeholder="ë¶„"><input class="info-field" placeholder="ì´ˆ"></div></div>`;
    html += `<div class="ws-content"><div class="columns">`;
    // left grid
    html += `<div class="left-grid">`;
    left.forEach(p=>{
      html += `<div class="problem-cell"><div class="vertical-problem"><div class="num1">${p.a}</div><div class="op-row"><div class="op">${op}</div><div class="num2">${p.b}</div></div><div class="line"></div><div class="answer-space"></div></div></div>`;
    });
    // fill blanks if needed
    for(let k=left.length;k<10;k++){
      html += `<div class="problem-cell"><div style="width:100%;height:100%;"></div></div>`;
    }
    html += `</div>`;
    // right list
    html += `<div class="right-list">`;
    right.forEach(p=>{
      html += `<div class="horizontal-problem"><span>${p.a}</span><span>${op}</span><span>${p.b}</span><span>=</span><div class="answer-box"></div></div>`;
    });
    for(let k=right.length;k<10;k++){
      html += `<div class="horizontal-problem"></div>`;
    }
    html += `</div>`;
    html += `</div></div>`;
    html += `<div class="ws-footer">eddie math</div>`;
    html += `</div>`;
    return html;
  }
  function createAnswerHTML(){
    let html = `<div class="answer-sheet"><h2>ğŸ“‹ ì—°ì‚° ë‹µì•ˆì§€</h2><div class="answer-content">`;
    worksheets.forEach(ws=>{
      const addAnswers = ws.add.map((p,i)=>`${i+1}) ${p.a + p.b}`).join(' ');
      const subAnswers = ws.sub.map((p,i)=>`${i+1}) ${p.a - p.b}`).join(' ');
      html += `<div class="answer-day"><div>${ws.day}ì¼ì°¨ ë§ì…ˆ: ${addAnswers}</div><div>${ws.day}ì¼ì°¨ ëº„ì…ˆ: ${subAnswers}</div></div>`;
    });
    html += `</div><div style="text-align:center;margin-top:12px;font-weight:700;color:#9ca3af;">eddie math - ë‹µì•ˆì§€</div></div>`;
    return html;
  }
  function render(){
    if(!worksheets || worksheets.length === 0){
      printArea.innerHTML = '';
      message.style.display = 'block';
      return;
    }
    message.style.display = 'none';
    if(showAnswer){
      printArea.innerHTML = createAnswerHTML();
      return;
    }
    // Build pages: for each day, create addition page then subtraction page
    let out = '';
    worksheets.forEach(ws=>{
      out += createWorksheetHTML(ws.day, ws.add, '+', 'ë§ì…ˆ');
      out += createWorksheetHTML(ws.day, ws.sub, 'âˆ’', 'ëº„ì…ˆ');
    });
    printArea.innerHTML = out;

    // ì¶”ê°€: render í›„ ì¦‰ì‹œ ë¦¬í”Œë¡œìš° ê°•ì œ (DOM ì•ˆì •í™”)
    void printArea.offsetHeight;
    console.log('Render reflow forced'); // ë””ë²„ê¹…ìš©
  }
  // Expose for debug (optional)
  window._debug_getWorksheets = ()=>worksheets;
})();