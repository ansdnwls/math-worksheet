<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì•„ë¹ í‘œ ì—°ì‚° í•™ìŠµì§€ (A4 ì¸ì‡„ ìµœì í™”)</title>
<!-- html3pdf CDN (í¬í¬ ë²„ì „) -->
<script src="https://unpkg.com/html3pdf@latest/dist/html3pdf.bundle.min.js"></script>
<!-- html2canvas CDN (ì´ë¯¸ì§€ ì €ì¥ìš©) -->
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<!-- jsZip CDN (ZIP ì••ì¶•ìš©) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<!-- FileSaver.js CDN (iOS ë‹¤ìš´ë¡œë“œ í˜¸í™˜) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
  /* Reset */
  * { box-sizing: border-box; margin:0; padding:0; }
  html,body { height:100%; }
  body { font-family: Arial, Helvetica, sans-serif; background:#f3f4f6; padding:28px; }
  /* Container */
  .container { max-width:980px; margin:0 auto; }
  /* Control panel (hidden when printing) */
  .control { background:#fff; border-radius:12px; padding:16px; box-shadow:0 6px 18px rgba(0,0,0,.06); margin-bottom:20px; }
  .control-row { display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .controls-left { display:flex; gap:10px; align-items:center; }
  .controls-right { display:flex; gap:8px; align-items:center; }
  .btn { border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; }
  .btn-diff { background:#f3f4f6; color:#374151; }
  .btn-diff.active { background:#2563eb; color:#fff; box-shadow:0 4px 10px rgba(37,99,235,.14); }
  .btn-generate { background:#4f46e5; color:#fff; }
  .btn-reset { background:#e5e7eb; color:#374151; }
  .btn-answer { background:#16a34a; color:#fff; }
  .btn-print { background:#111827; color:#fff; } 
  input[type=number] { padding:8px; width:80px; border-radius:6px; border:1px solid #d1d5db; text-align:center; font-weight:700; }
  /* Print-area basic message */
  .message { text-align:center; color:#9ca3af; padding:56px 0; }
  /* Worksheet (A4) */
  .worksheet {
    width:210mm; /* A4 width */
    height:297mm; /* fixed heightë¡œ ë³€ê²½, ì´ˆê³¼ ë°©ì§€ */
    padding:15mm; /* inner margin for printable area */
    margin: 0 auto 18px;
    background:#fff;
    box-shadow:0 4px 10px rgba(0,0,0,.06);
    page-break-after: always; /* ensure each worksheet is its own printed page */
    overflow:hidden; /* ë„˜ì¹¨ ì½˜í…ì¸  ìˆ¨ê¹€ */
    box-sizing:border-box;
    display:block;
  }
  /* Header */
  .ws-header { text-align:center; margin-bottom:8px; }
  .ws-title { font-size:28px; font-weight:900; display:inline-block; padding-bottom:8px; border-bottom:4px solid #e5e7eb; }
  .day-num { font-size:40px; color:#f59e0b; margin-right:8px; font-family:serif; }
  .ws-info { display:flex; justify-content:space-between; align-items:flex-end; gap:12px; margin-top:12px; margin-bottom:8px; }
  .info-group { display:flex; gap:8px; align-items:center; }
  .info-field { width:48px; height:32px; border:1px solid #cbd5e1; border-radius:6px; text-align:center; font-weight:700; }
  /* Content block: use grid for stable heights */
  .ws-content { display:block; border-top:2px solid #000; border-bottom:2px solid #000; margin-top:8px; height: calc(100% - 132px); }
  /* height calc assumes header + footer ~132px; ensures left-grid and right-list share available vertical space */
  .columns { display:grid; grid-template-columns: 1fr 1fr; height:100%; }
  /* Left: 2x5 grid */
  .left-grid { display:grid; grid-template-columns: 1fr 1fr; grid-template-rows: repeat(5, 1fr); gap:0; border-right:2px solid #000; height:100%; }
  .problem-cell { padding:12px; display:flex; align-items:center; justify-content:center; border-right:1px solid #e5e7eb; border-bottom:1px solid #e5e7eb; }
  .problem-cell:nth-child(2n) { border-right:none; }
  .problem-cell:nth-child(n+9) { border-bottom:none; }
  .vertical-problem { width:100%; display:flex; flex-direction:column; align-items:flex-end; font-family:monospace; font-size:28px; font-weight:800; }
  .vertical-problem .num1 { margin-bottom:6px; }
  .vertical-problem .op-row { width:100%; display:flex; justify-content:flex-end; align-items:center; gap:8px; }
  .vertical-problem .op { margin-right:auto; padding-right:8px; } /* operator placed left inside row */
  .vertical-problem .line { width:100%; border-top:2px solid #000; margin-top:8px; }
  .vertical-problem .answer-space { height:44px; }
  /* Right: 10 horizontal lines */
  .right-list { display:grid; grid-template-rows: repeat(10, 1fr); height:100%; padding-left:12px; }
  .horizontal-problem { display:flex; align-items:center; padding-left:8px; font-family:monospace; font-size:18px; font-weight:700; border-bottom:1px solid #e5e7eb; }
  .horizontal-problem:last-child { border-bottom:none; }
  .horizontal-problem span { margin-right:8px; }
  .answer-box { width:96px; height:36px; border:2px solid #d1d5db; border-radius:6px; margin-left:12px; }
  .ws-footer { text-align:center; margin-top:8px; color:#9ca3af; font-weight:700; }
  /* Answer sheet */
  .answer-sheet { width:210mm; height:297mm; /* fixed for A4 */ padding:15mm; margin:0 auto 18px; background:#fff; box-shadow:0 4px 10px rgba(0,0,0,.06); page-break-after:always; overflow:hidden; }
  .answer-sheet h2 { text-align:center; margin-bottom:12px; }
  .answer-day { margin-bottom:8px; font-weight:700; color:#374151; }
  /* Print overrides */
  @media print {
    body { background:white; padding:0; }
    .control { display:none !important; }
    .container { padding:0; }
    .worksheet, .answer-sheet { box-shadow:none; margin:0; height:auto; /* print ì‹œ flexible */ }
    @page { size: A4; margin: 0; } /* Use printer margins or 0 depending on printer support */
  }
  /* small screen convenience */
  @media (max-width:760px) {
    body { padding:12px; }
    .container { padding:0 8px; }
  }
</style>
</head>
<body>
  <div class="container">
    <!-- Control -->
    <div class="control">
      <div class="control-row">
        <div class="controls-left">
          <strong style="font-size:16px;">ğŸ§® ì•„ë¹ í‘œ ì—°ì‚° í•™ìŠµì§€ ë§Œë“¤ê¸°</strong>
          <div style="display:flex; gap:8px; margin-left:12px;">
            <button class="btn btn-diff" id="btn-one">1ìë¦¬</button>
            <button class="btn btn-diff active" id="btn-two">2ìë¦¬</button>
            <button class="btn btn-diff" id="btn-three">3ìë¦¬</button>
          </div>
        </div>
        <div class="controls-right">
          <label style="font-weight:700; margin-right:6px;">ìƒì„± ì¼ìˆ˜</label>
          <input id="numDays" type="number" min="1" max="30" value="1" />
          <button class="btn btn-generate" id="genBtn">âœ¨ ë¬¸ì œ ìƒì„±</button>
          <button class="btn btn-reset" id="resetBtn">â†» ì´ˆê¸°í™”</button>
          <button class="btn btn-answer" id="answerBtn" disabled>ğŸ“‹ ë‹µì•ˆì§€ ì¶œë ¥</button>
          <button class="btn btn-print" id="pdfBtn" disabled>ğŸ“¥ PDF ë‹¤ìš´ë¡œë“œ</button>
          <button class="btn btn-print" id="imgBtn" disabled>ğŸ–¼ï¸ ì´ë¯¸ì§€ ì €ì¥</button>
        </div>
      </div>
    </div>
    <!-- Print area -->
    <div id="printArea"></div>
    <div id="message" class="message">ë¬¸ì œë¥¼ ìƒì„±í•˜ë©´ ì—¬ê¸°ì— ë¯¸ë¦¬ë³´ê¸°ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</div>
  </div>
<script>
(function(){
  // State
  let difficulty = 'two';
  let worksheets = [];
  let showAnswer = false;
  // Ranges
  const ranges = {
    one: { min:1, max:9 },
    two: { min:10, max:99 },
    three: { min:100, max:999 }
  };
  // Utilities
  function randomIn(range){
    return Math.floor(Math.random() * (range.max - range.min + 1)) + range.min;
  }
  // DOM
  const btnOne = document.getElementById('btn-one');
  const btnTwo = document.getElementById('btn-two');
  const btnThree = document.getElementById('btn-three');
  const genBtn = document.getElementById('genBtn');
  const resetBtn = document.getElementById('resetBtn');
  const answerBtn = document.getElementById('answerBtn');
  const pdfBtn = document.getElementById('pdfBtn');
  const imgBtn = document.getElementById('imgBtn');
  const numDaysInput = document.getElementById('numDays');
  const printArea = document.getElementById('printArea');
  const message = document.getElementById('message');
  // Set difficulty UI
  function setDifficulty(level, el){
    difficulty = level;
    [btnOne, btnTwo, btnThree].forEach(b => b.classList.remove('active'));
    if(el) el.classList.add('active');
  }
  btnOne.addEventListener('click', ()=> setDifficulty('one', btnOne));
  btnTwo.addEventListener('click', ()=> setDifficulty('two', btnTwo));
  btnThree.addEventListener('click', ()=> setDifficulty('three', btnThree));
  // Generate
  function generateProblems(){
    const range = ranges[difficulty];
    const days = Math.max(1, Math.min(30, parseInt(numDaysInput.value, 10) || 1));
    worksheets = [];
    for(let day=1; day<=days; day++){
      const add = [];
      const sub = [];
      while(add.length < 20){
        const a = randomIn(range);
        const b = randomIn(range);
        if(a % 10 === b % 10) continue; // avoid same unit digit
        add.push({a,b});
      }
      while(sub.length < 20){
        let a = randomIn(range);
        let b = randomIn(range);
        if(a % 10 === b % 10) continue;
        if(a < b) [a,b] = [b,a];
        sub.push({a,b});
      }
      worksheets.push({ day, add, sub });
    }
    showAnswer = false;
    render();
    answerBtn.disabled = false;
    pdfBtn.disabled = false;
    imgBtn.disabled = false;
  }
  function resetAll(){
    worksheets = [];
    showAnswer = false;
    printArea.innerHTML = '';
    message.style.display = 'block';
    answerBtn.disabled = true;
    pdfBtn.disabled = true;
    imgBtn.disabled = true;
  }
  function toggleAnswer(){
    showAnswer = !showAnswer;
    render();
  }
  genBtn.addEventListener('click', generateProblems);
  resetBtn.addEventListener('click', resetAll);
  answerBtn.addEventListener('click', toggleAnswer);
  // PDF ë‹¤ìš´ë¡œë“œ
  pdfBtn.addEventListener('click', () => {
    document.querySelector('.control').style.display = 'none';
    message.style.display = 'none';
    const opt = {
      margin: 0,
      filename: 'math_worksheet.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait', compress: true },
      pagebreak: { mode: ['css', 'legacy'] }
    };
    setTimeout(() => {
      html3pdf().set(opt).from(printArea).save().then(() => {
        document.querySelector('.control').style.display = 'block';
        if (!worksheets.length) message.style.display = 'block';
      });
    }, 500);
  });
  // ì´ë¯¸ì§€ ì €ì¥ (ZIP ì••ì¶• ë²„ì „)
  imgBtn.addEventListener('click', async () => {
    const sheets = Array.from(printArea.querySelectorAll('.worksheet, .answer-sheet'));
    if (sheets.length === 0) return;

    const zip = new JSZip(); // ZIP ìƒì„±
    const promises = sheets.map(async (sheet, index) => {
      const canvas = await html2canvas(sheet, { scale: 2, useCORS: true });
      const imgData = canvas.toDataURL('image/png');
      console.log(`Processing page ${index + 1}`); // ë””ë²„ê·¸
      zip.file(`worksheet_page_${index + 1}.png`, imgData.split(',')[1], {base64: true}); // ZIPì— ì¶”ê°€
      return imgData; // ê°œë³„ ë‹¤ìš´ë¡œë“œìš© (ZIP ëŒ€ì•ˆ)
    });

    try {
      const dataURLs = await Promise.all(promises);
      console.log('All images processed:', dataURLs.length); // ë””ë²„ê·¸

      // ZIP ë‹¤ìš´ë¡œë“œ (ê¶Œì¥: í•œ íŒŒì¼ë¡œ ì „ì²´)
      zip.generateAsync({type: 'blob'}).then(blob => {
        saveAs(blob, 'worksheets.zip');
      });
    } catch (err) {
      console.error('Image save error:', err);
    }
  });
  // Render helpers
  function createWorksheetHTML(day, problems, op, title){
    const left = problems.slice(0,10);
    const right = problems.slice(10,20);
    let html = '';
    html += `<div class="worksheet">`;
    html += `<div class="ws-header"><div class="ws-title"><span class="day-num">${day}</span>ì¼ì°¨ - ${title}</div></div>`;
    html += `<div class="ws-info"><div class="info-group">ğŸ“…<input class="info-field" placeholder="ì›”"><input class="info-field" placeholder="ì¼"></div><div class="info-group">ğŸ•<input class="info-field" placeholder="ë¶„"><input class="info-field" placeholder="ì´ˆ"></div></div>`;
    html += `<div class="ws-content"><div class="columns">`;
    // left grid
    html += `<div class="left-grid">`;
    left.forEach(p=>{
      html += `<div class="problem-cell"><div class="vertical-problem"><div class="num1">${p.a}</div><div class="op-row"><div class="op">${op}</div><div class="num2">${p.b}</div></div><div class="line"></div><div class="answer-space"></div></div></div>`;
    });
    // fill blanks if needed
    for(let k=left.length;k<10;k++){
      html += `<div class="problem-cell"><div style="width:100%;height:100%;"></div></div>`;
    }
    html += `</div>`;
    // right list
    html += `<div class="right-list">`;
    right.forEach(p=>{
      html += `<div class="horizontal-problem"><span>${p.a}</span><span>${op}</span><span>${p.b}</span><span>=</span><div class="answer-box"></div></div>`;
    });
    for(let k=right.length;k<10;k++){
      html += `<div class="horizontal-problem"></div>`;
    }
    html += `</div>`;
    html += `</div></div>`;
    html += `<div class="ws-footer">eddie math</div>`;
    html += `</div>`;
    return html;
  }
  function createAnswerHTML(){
    let html = `<div class="answer-sheet"><h2>ğŸ“‹ ì—°ì‚° ë‹µì•ˆì§€</h2><div class="answer-content">`;
    worksheets.forEach(ws=>{
      const addAnswers = ws.add.map((p,i)=>`${i+1}) ${p.a + p.b}`).join(' ');
      const subAnswers = ws.sub.map((p,i)=>`${i+1}) ${p.a - p.b}`).join(' ');
      html += `<div class="answer-day"><div>${ws.day}ì¼ì°¨ ë§ì…ˆ: ${addAnswers}</div><div>${ws.day}ì¼ì°¨ ëº„ì…ˆ: ${subAnswers}</div></div>`;
    });
    html += `</div><div style="text-align:center;margin-top:12px;font-weight:700;color:#9ca3af;">eddie math - ë‹µì•ˆì§€</div></div>`;
    return html;
  }
  function render(){
    if(!worksheets || worksheets.length === 0){
      printArea.innerHTML = '';
      message.style.display = 'block';
      return;
    }
    message.style.display = 'none';
    if(showAnswer){
      printArea.innerHTML = createAnswerHTML();
    } else {
      let out = '';
      worksheets.forEach(ws=>{
        out += createWorksheetHTML(ws.day, ws.add, '+', 'ë§ì…ˆ');
        out += createWorksheetHTML(ws.day, ws.sub, 'âˆ’', 'ëº„ì…ˆ');
      });
      printArea.innerHTML = out;
    }
  }
  // Expose for debug (optional)
  window._debug_getWorksheets = ()=>worksheets;
})();
</script>
</body>
</html>